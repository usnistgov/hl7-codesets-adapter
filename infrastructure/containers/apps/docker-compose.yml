version: "3.3"
services:
  codesets-adapter-db:
    build: ./codesets-adapter-db
    image: codesets-adapter-db
    networks:
      - codesets-adapter-network
    container_name: codesets-adapter-db
    hostname: codesets-adapter-db
    expose:
      - "27017"
    healthcheck:
      test: ["CMD-SHELL", "mongo localhost:27017 --eval db.serverStatus()"]
      interval: 30s
      timeout: 30s
      retries: 3
    volumes:
      - ../../data/codesets-adapter-db/db:/data/db
    env_file:
      - ./codesets-adapter-db/config/db.env
    restart: unless-stopped

  codesets-adapter:
    build:
      context: ../../../  # Sets the build context to the project root
      dockerfile: infrastructure/containers/apps/codesets-adapter/Dockerfile  # Specifies the Dockerfile location
    # image: ${DOCKER_REGISTRY}/inm1/hl7-codesets-adapter:${CI_COMMIT_SHA}
    image: ${DOCKER_REGISTRY}/inm1/hl7-codesets-adapter:latest  # Use 'latest' tag for auto-updates
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    networks:
      - codesets-adapter-network
    expose:
      - "8880"
    ports:
      - "8880:8080"
    container_name: codesets-adapter
    depends_on:
      - codesets-adapter-db
    env_file:
      - ./codesets-adapter-db/config/db.env
    links:
      - codesets-adapter-db:codesets-adapter-db
    volumes:
      - ../../data/codesets-adapter/logs/:/var/log/codesets-adapter/
    restart: unless-stopped

networks:
  codesets-adapter-network:
